---
title: "Специфика медицинских данных"
author: "Ekaterina Vostokova"
date: "2024-11-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tibble)
library(readxl)
library(rstatix)
library(pROC)
library(gtsummary)
```

После чтения датасата, производятся некоторые шаги для его предобработки:
- Добавлена переменная hem_level, отражающая, находится ли уровень гемоглобина в пределах референса или же отличается в ту или другую сторону
- Все качественные переменные переведены в факторы
- Дюймы и фунты переведены в метры и килограммы, соответственно, а также переведены в количественные переменные

```{r read_mutate}
data_init <- as_tibble(read_excel("trauma.xlsx"))
data_m <- data_init %>% 
  filter(Sex == "Male") %>% 
  mutate(hem_level = cut(Hb, breaks = c(-Inf, 13.5, 16, Inf), labels = c("Понижен", "В норме", "Повышен")))
data_f <- data_init %>% 
  filter(Sex == "Female") %>% 
  mutate(hem_level = cut(Hb, breaks = c(-Inf, 12, 14, Inf), labels = c("Понижен", "В норме", "Повышен")))
data <- rbind(data_m, data_f)
data <- data %>%
  mutate(across(where(is.character), function(x) as.factor(x)))
data <- data %>%
  mutate(Height = as.numeric(gsub("[^0-9.]", "", Height))) %>%
  mutate(Height = Height*2.54/100)
data <- data %>%
  mutate(Weight = Weight/2.2)
data
```


### Задание 1. Описательные статистики и пониженный гемоглобин

Дайте описательную статистику для переменных, включённых в датасет. Дополнительно
рассчитайте, у какого количества пациентов и в каком проценте случаев у пациентов был
снижен уровень гемоглобина? Используйте следующие референтные значения (Мужчины:
13.5–16 г/дл, Женщины: 12–14 г/дл).

```{r overview}
data %>% 
    select(Sex,
           Age,
           Height,
           Weight,
           SBP,
           DBP,
           FOUR, 
           GSC, 
           Hb, 
           Death, 
           hem_level) %>% 
    tbl_summary(by = Death) %>% 
    add_p()
```


```{r hem_level_lower}
number_lower <- length(which(data$hem_level == "Понижен"))
percent_lower <- length(which(data$hem_level == "Понижен")) / nrow(data)

output <- paste("Количество пациентов с пониженным гемоглобином:", number_lower, 
                "Доля пациентов с пониженным гемоглобином:", round(percent_lower, 2)*100, "%")
print(output)
```

Следовательно, в датасете есть 515 пациентов с пониженным гемоглобином, что составляет примерно 50% от общего числа пациентов.


### Задание 2. ИМТ пациентов

Рассчитайте индекс массы тела у пациентов (кг / м2). Каков был средний (M (SD)) уровень
ИМТ у пациентов, включённых в исследование? Какая доля пациентов имела ожирение (ИМТ
> 30)?

```{r imt}
data <- data %>%
  mutate(IMT = as.numeric(Weight / (Height)**2)) 
mean_imt <- data %>%
  summarise(mean_IMT = mean(IMT), 
            sd_IMT = sd(IMT))
large_imt <- data %>%
  filter(IMT > 30) %>%
  nrow()

output <- paste("Средний ИМТ:", round(mean_imt$mean_IMT, 2), 
                "Стандартное отклонение:", round(mean_imt$sd_IMT, 2), 
                "Доля пациентов с ИМТ больше 30:", large_imt/nrow(data)*100, "%")
print(output)
```

Итак, средний ИМТ в датасете составил 26.06 (sd = 2.57), а количество пациентов с ИМТ больше 30 составило 71 человек, то есть приблизительно 7%.




### Задание 3. ROC-кривая
Как выглядит ROC-кривая для предсказания летального исхода в течение 24 часов по
переменной, характеризующей уровень гемоглобина? Постройте график. Чем может быть
обусловлена такая форма кривой?

```{r roc, fig.height=3, fig.width=3, dpi=300}
roc_curve_1 <- roc(Death ~ Hb, 
                   data = data)

roc_curve_1 %>% 
    ggroc() + 
    theme_bw()

```

Roc кривая достаточно близка к диагонали, следовательно, уровень гемоглобина не очень эффективно предсказывает наступление смерти в течение суток. 


### Задание 4. Площадь под ROC-кривой

Чему равна площадь под ROC-кривой, которую вы построили в вопросе 3? Чему равен 95%
двусторонний ДИ для площади под ROC-кривой, которую вы построили в вопросе 3?


```{r auc, message=FALSE}
data %>%
  summarise(
    AUC = round(roc(Death ~ Hb, data = data)$auc, 3),
    AUC_LCL = round(roc(Death ~ Hb, data = data, ci = TRUE)$ci[1], 3),
    AUC_UCL = round(roc(Death ~ Hb, data = data, ci = TRUE)$ci[3], 3)
  )
```
Площадь под кривой получилась 0.70, при этом нижняя граница доверительного интервала (AUC_LCL) составляет 0.669, а верхняя (AUC_UCL) 0.732. Эти значения показывают умеренную предсказательную способность уровня гемоглобина в отношении смерти пациента в течение первых 24 часов.


### Задание 5. Летальный исход и шкала комы Глазго

Проведите ROC-анализ и определите, какое пороговое значение является оптимальным для
предсказания летального исхода в течение 24 часов по шкале комы Глазго. Какой
чувствительностью и специфичностью обладает данный порог?

```{r other_auc, message=FALSE}
roc_curve_2 <- roc(Death ~ GSC, 
                   data = data) 
roc_curve_2 %>% coords(x = "best", best.method = "closest.topleft")
```

Для предсказания летального исхода в течение 24 часов по шкале комы Глазго оптимальный порог 7.5. При этом значении достигается максимальный баланс между специфичностью и чувствительностью, они будут составлять 0.80 и 0.85 соответственно. В целом, это достаточно хорошие показатели.


### Задание 6. Наибольшая и наименьшая площадь под ROC-кривой

Какая из количественных переменных в датасете (включая рассчитанный вами ранее ИМТ)
обладает наибольшей площадью под ROC-кривой? Как вы можете интерпретировать это
знание? Какая количественная переменная имеет наименьшую площадь?


```{r all_variables_roc, message=FALSE}

data %>% names()

data %>% 
    select("Sex",
           "Age",
           "Height",
           "Weight",
           "SBP",
           "DBP",
           "FOUR", 
           "GSC", 
           "Hb", 
           "IMT",
           "Death", 
           "hem_level") %>% 
    select(where(is.numeric), Death) %>%
  
    pivot_longer(cols = !Death) %>% 
    
    group_by(name) %>% 
    
    summarise(AUC = roc(Death, value, ci = T)$ci[2] %>% round(3),
              AUC_LCL = roc(Death, value, ci = T)$ci[1] %>% round(3),
              AUC_UCL = roc(Death, value, ci = T)$ci[3] %>% round(3)) %>% 
    arrange(desc(AUC))
```

Наибольшая площадь под ROC-кривой у переменной FOUR (балл по шкале комы FOUR при поступлении), соответственно эта переменная наиболее точно предсказывает летальный исход у пациента. Наименьшая площадь - у роста (height), она даже меньше 0.5 (диагональ), и совершенно не обладает предсказательной способностью в отношении летального исхода за первые 24 часа.
